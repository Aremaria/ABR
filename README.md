## Модель прогноза резистентности микроорганизма к антимикробному препарату

### Описание 

**Цель** - прогнозировать динамику резистентности по годам.

**Резистентность** - результат теста выявленного возбудителя на антимикробную утойчивость,  
определяется как 1 или 0 для единичного наблюдения, либо как доля положительных тестов к  
общему числу проведенных тестов для пары препарат-микроорганизм для крупных срезов  
(регион, год).

**Срезы для данных АБР** - регион проживания, год наблюдения, микроорганизм, препарат.  
**Срезы для данных DDDs** - регион, месяц, препарат, значение ddd, канал сбыта (госпитальное  
потребление или розничная продажа).

---
### Выбор класса моделей 

С одной стороны прогнозирование резистентности на крупном срезе (год) предполагает использование  
регрессоров, однако сведение персональных тестов к годовым показателям резистентности сильно  
снижает размерность данных. Поэтому было принято решение обучать классификатор на исходных данных  
в минимальной детализации, а затем предсказанную вероятность резистентного результата для каждого 
случая усреднять по годам (регионы при таком подходе взвешиваются автоматически по числу тестов). 

В результате и размерность данных не уменьшили, и по сути на выходе регрессор по временным точкам  
(годам) получили. В качестве классификатора взят классификатор ***LightGBM*** - он мощный, шустрее  
других бустингов, довольно адекватно обучается на данных от нескольких тысяч наблюдений, довольно  
просто калибруется при переобучении, а еще это модный метод.

Из минусов подхода - все алгоритмы на деревьях не обладают предсказательной способностью, в отличие  
от той же линейной регрессии, поэтому адекватное предсказание происходит в известных пределах  
колебания независимых факторов (известных из данных для обучения). Из-за этой особенности в ходе  
прогнозирования на новый горизонт применена условная оптимизация методом ***COBYLA*** с ограниченями  
для данных потребления. 

Для предотвращения переобучения, а так же снижения уровня шума и исключения взаимосвязи переменных  
используется ***PCA***.  

---
###  Подготовка 
Нужно скачать исходные данные (не находятся в публичном доступе), сформировать каталог проекта  
согласно тому, как это выглядит здесь, далее устновить нужные библиотеки из requirements.

---
### Этапы 

Последовательность выполнения действий описана в модуле ***'MAIN'***.

- **Первым этапом** происходит подготовка данных (модуль ***'prep'***), предобработка
(функции ***MakeReport***) и затем непосредственная подготовка данных для моделирования
(функции ***MakeFinal***).

- **Вторым этапом**  происходит обучение модели (модуль ***'model'***), валидация, калибровка
гиперпараметров модели, оценка метрик, анализ чувствительности (модуль ***'SensAnalysis'***)
и оценка важности признаков. В этом же блоке перед моделированием производится добавление
расчетных признаков к данным (модуль ***'features'***).

Моделирование производится три раза: в первом случае *все данные по потреблению полные*,  
во втором - происходит *отсев некоторых препаратов* (основано на экспертном мнении специалистов),  
в третьем - *потребление исключено из списка признаков*.

- **Третий этап** - прогноз и оптимизация (модули ***'forecast'***, ***'optimazation'***).
Для прогнозирования целевого показателя (резистентности) необходимо предварительно
спрогнозировать/спланировать будущую динамику потребления препаратов. Для этого рассчитывается
*линейный прогноз по годам* для каждого препарата (без учета регионов - предполагается,
что динамика везде +/- одинаковая), *линейный прогноз на очищенных данных* (выбросы 2020 и 2021
не учитываются - пандемийные года), а так же *оптимальный уровень потребления* для каждого
препарата для внутрибольничного и внебольничного потребления отдельно (базы Retail и Hospital).  
Оптимальный уровень потребления рассчитывается таким образом, чтобы минимизировать резистентность
за год.

---
### Прочее 
Для удобства некоторые функции вынесены в модуль ***'functions'***. Результаты всех расчетов можно  
посмотреть в приложении ***'app'*** (в ***'pic'*** прописаны картинки для него).
